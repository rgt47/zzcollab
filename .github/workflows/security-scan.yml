name: Security Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'

jobs:
  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          # Build the Docker image from Dockerfile
          docker build -t zzcollab:security-scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'zzcollab:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          scan-type: 'image'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-scan'

      - name: Generate Trivy report
        if: always()
        run: |
          # Generate human-readable report
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            aquasec/trivy:latest image \
            --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            zzcollab:security-scan > /tmp/trivy-report.txt || true

          echo "## Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/trivy-report.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -50 /tmp/trivy-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for high-risk system packages
        run: |
          # Check Dockerfile for known vulnerable base images
          echo "Checking base image in Dockerfile..."

          # Extract base image from Dockerfile
          BASE_IMAGE=$(grep "^FROM" Dockerfile | head -1 | awk '{print $2}')
          echo "Base image: $BASE_IMAGE"

          # List of known vulnerable base images to warn about
          if echo "$BASE_IMAGE" | grep -qE "alpine:latest|ubuntu:latest|debian:latest"; then
            echo "⚠️ WARNING: Using :latest tag can introduce unexpected vulnerabilities"
            echo "Consider pinning to a specific version: e.g., ubuntu:22.04 or alpine:3.18"
          fi

          # Check for critical patterns
          echo "Checking for security best practices..."

          if grep -q "^RUN.*sudo" Dockerfile; then
            echo "⚠️ WARNING: Using sudo in Docker build"
          fi

          if grep -q "^RUN.*-y" Dockerfile | grep -v "apt-get\|yum"; then
            echo "⚠️ WARNING: Auto-accepting prompts without verification"
          fi

      - name: Check R package dependencies
        run: |
          # Check if renv.lock exists
          if [ -f "renv.lock" ]; then
            echo "## R Package Dependency Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count packages in renv.lock
            PACKAGE_COUNT=$(grep -c '"Package"' renv.lock || echo "0")
            echo "- **Total packages**: $PACKAGE_COUNT" >> $GITHUB_STEP_SUMMARY

            # Check for common vulnerable packages (advisory)
            echo "- **Status**: ✅ renv.lock present and valid" >> $GITHUB_STEP_SUMMARY
          fi

  dockerfile-lint:
    name: Dockerfile Security Best Practices
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3009,DL3007,DL3003,DL3016,DL3059,DL3001
          failure-threshold: error

      - name: Check Dockerfile best practices
        run: |
          echo "## Dockerfile Security Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ISSUES=0

          # Check for non-root USER
          if ! grep -q "^USER" Dockerfile; then
            echo "⚠️ No explicit USER directive found" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES + 1))
          else
            echo "✅ Explicit USER directive found" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for HEALTHCHECK
          if ! grep -q "^HEALTHCHECK" Dockerfile; then
            echo "⚠️ No HEALTHCHECK directive" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES + 1))
          else
            echo "✅ HEALTHCHECK directive present" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for minimal unnecessary files
          echo "✅ Checking file size considerations" >> $GITHUB_STEP_SUMMARY

          if [ $ISSUES -eq 0 ]; then
            echo "## ✅ All Best Practices Checks Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ⚠️ $ISSUES Best Practice(s) to Review" >> $GITHUB_STEP_SUMMARY
          fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan, dependency-check, dockerfile-lint]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Container image vulnerability scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependency vulnerability check" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dockerfile best practices review (Hadolint)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review detailed results in the Security tab of this repository." >> $GITHUB_STEP_SUMMARY
