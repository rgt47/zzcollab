---
title: "Reproducible Blog Post Development with ZZCOLLAB"
author: "ZZCOLLAB Development Team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Reproducible Blog Post Development with ZZCOLLAB}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Introduction

This vignette demonstrates how to create **reproducible blog posts** using ZZCOLLAB, following the unified research compendium framework [@marwick2018]. Each blog post becomes a self-contained reproducible project that readers can clone and execute independently.

**Key Philosophy**: Blog posts containing data analysis should be **as reproducible as academic papers**. Each post directory is a complete ZZCOLLAB project with Docker, renv, and the five pillars of reproducibility. The blog post itself lives in `analysis/report/`, consistent with the manuscript workflow.

## What You Will Learn

- Structuring blog posts as reproducible research compendia
- Using symlinks to integrate with Quarto's blog system
- Organizing media assets (images, audio, video)
- Running Quarto blog development inside Docker containers
- Managing dependencies with renv for exact reproducibility

## Prerequisites

- Docker installed and running
- ZZCOLLAB installed (`./install.sh`)
- An existing Quarto blog (or willingness to create one)
- Git configured with credentials

# The Blog Post as Research Compendium

## Structure Overview

Each blog post follows the unified compendium structure with a dual-symlink system that enables intuitive editing while maintaining Quarto compatibility:

```
posts/palmer_penguins_part1/
├── index.qmd → analysis/report/index.qmd     # Symlink for Quarto
├── figures/ → analysis/figures/              # Symlink for HTML resolution
├── media/ → analysis/media/                  # Symlink for HTML resolution
├── data/ → analysis/data/                    # Symlink for HTML resolution
│
├── Dockerfile                                # Computational environment
├── renv.lock                                 # Exact package versions
├── .Rprofile                                 # R session configuration
├── DESCRIPTION                               # Project metadata
├── Makefile                                  # Build commands
├── README.md                                 # Reader instructions
│
├── analysis/
│   ├── paper/
│   │   ├── index.qmd                         # Blog post content (actual file)
│   │   ├── figures/ → ../figures/            # Symlink for intuitive editing
│   │   ├── media/ → ../media/                # Symlink for intuitive editing
│   │   └── data/ → ../data/                  # Symlink for intuitive editing
│   │
│   ├── scripts/                              # Numbered analysis pipeline
│   │   ├── 01_prepare_data.R
│   │   ├── 02_fit_models.R
│   │   └── 03_generate_figures.R
│   │
│   ├── figures/                              # R-generated plots (actual)
│   │   ├── eda-overview.png
│   │   └── model-diagnostics.png
│   │
│   ├── media/                                # Static media assets (actual)
│   │   ├── images/                           # Hero images, photos
│   │   │   ├── README.md                     # Source/license info
│   │   │   └── penguin-hero.jpg
│   │   ├── audio/                            # Podcasts, narration
│   │   │   └── episode-summary.mp3
│   │   └── video/                            # Demos, tutorials
│   │       └── analysis-walkthrough.mp4
│   │
│   └── data/
│       ├── raw_data/                         # Original data (read-only)
│       │   └── README.md
│       └── derived_data/                     # Processed data, models
│           ├── penguins_clean.csv
│           └── simple_model.rds
│
└── R/                                        # Reusable functions (optional)
    └── utils.R
```

## Why Dual Symlinks?

Quarto blogs expect `posts/*/index.qmd` at the post root, but ZZCOLLAB places documents in `analysis/report/`. The dual-symlink system addresses this:

**At post root** (for Quarto and HTML resolution):
```
index.qmd → analysis/report/index.qmd
figures/  → analysis/figures/
media/    → analysis/media/
data/     → analysis/data/
```

**In analysis/report/** (for intuitive editing):
```
figures/ → ../figures/
media/   → ../media/
data/    → ../data/
```

**Benefits**:

1. **Quarto compatibility**: Finds `index.qmd` at expected location
2. **Intuitive paths**: Write `![Plot](figures/plot.png)` in your `.qmd`
3. **Correct HTML**: Rendered paths resolve via root symlinks
4. **rrtools consistency**: Actual content lives in `analysis/report/`

## Directory Purposes

| Directory | Contents | Generated By |
|-----------|----------|--------------|
| `analysis/figures/` | R-generated plots | `analysis/scripts/` |
| `analysis/media/images/` | Static images (hero, photos) | Manual/external |
| `analysis/media/audio/` | Audio files (podcasts) | External tools |
| `analysis/media/video/` | Video files (demos) | External tools |
| `analysis/data/raw_data/` | Source data (read-only) | External/downloaded |
| `analysis/data/derived_data/` | Processed data, models | `analysis/scripts/` |

# Step-by-Step: Creating a Reproducible Blog Post

## Step 1: Initialize Post as ZZCOLLAB Project

```bash
cd ~/prj/qblog/posts

# Create post directory
mkdir palmer_penguins_part1 && cd palmer_penguins_part1

# Initialize with publishing profile (includes Quarto)
zzcollab -r ubuntu_standard_publishing
```

## Step 2: Set Up Blog Structure

Run the `setup_symlinks.sh` script to create the blog post structure:

```bash
# Run the setup script (creates symlinks, media dirs, and index.qmd template)
modules/setup_symlinks.sh
```

This single command:

1. Creates media directories (`analysis/media/{images,audio,video}/`)
2. Copies the `index.qmd` template to `analysis/report/`
3. Creates root-level symlinks for Quarto compatibility
4. Creates `analysis/report/` symlinks for intuitive editing

**Verify the structure:**

```bash
# Check root-level symlinks
ls -la

# Check analysis/report/ symlinks
ls -la analysis/report/

# Check status anytime
modules/setup_symlinks.sh --status
```

**To remove blog structure** (revert to standard ZZCOLLAB project):

```bash
modules/setup_symlinks.sh --remove
```

## Step 3: Add Static Media Assets

```bash
# Hero image for blog listing
cp ~/assets/penguin-hero.jpg analysis/media/images/

# Supporting photos
cp ~/assets/palmer-station.jpg analysis/media/images/

# Document sources (important for attribution)
cat > analysis/media/images/README.md << 'EOF'
# Image Sources

## penguin-hero.jpg
- Source: Unsplash
- Photographer: John Doe
- License: Unsplash License
- URL: https://unsplash.com/photos/xxxxx

## palmer-station.jpg
- Source: Palmer LTER
- License: CC BY 4.0
EOF
```

## Step 4: Edit Blog Post

The `setup_symlinks.sh` script created a template at `analysis/report/index.qmd`.
Edit it to customize your post:

````markdown
---
title: "Palmer Penguins Analysis (Part 1): EDA and Simple Regression"
subtitle: "Getting acquainted with our Antarctic friends"
author: "Your Name"
date: "2025-01-15"
categories: [R Programming, Data Science, Palmer Penguins]
description: "Exploratory data analysis and simple regression modeling"
image: "media/images/penguin-hero.jpg"
execute:
  echo: true
  warning: false
  message: false
format:
  html:
    code-fold: false
---

![Palmer Station, Antarctica](media/images/palmer-station.jpg){.img-fluid}

# Introduction

Welcome to our exploration of the Palmer penguins dataset!

```{r}
#| label: setup
library(tidyverse)

# Load pre-computed results (generated by analysis/scripts/)
penguins_clean <- read_csv("data/derived_data/penguins_clean.csv")
model_results <- read_csv("data/derived_data/model_coefficients.csv")
```

# Exploratory Data Analysis

Our analysis reveals distinct patterns across species:

![Species distribution and morphometric relationships](figures/eda-overview.png)

# Model Results

```{r}
simple_model <- readRDS("data/derived_data/simple_model.rds")
summary(simple_model)
```

![Model diagnostic plots](figures/model-diagnostics.png)

# Video Walkthrough

```{=html}
<video width="100%" controls>
  <source src="media/video/analysis-walkthrough.mp4" type="video/mp4">
</video>
```

# Reproducibility

This post is a reproducible research compendium:

```bash
git clone <repo> && cd posts/palmer_penguins_part1
make docker-build && make docker-post-render
```

```{r}
sessionInfo()
```
````

**Note**: All paths are simple (`figures/`, `media/`, `data/`) because symlinks in `analysis/report/` resolve them to actual directories.

## Step 5: Create Analysis Scripts

### Script 1: Data Preparation

Create `analysis/scripts/01_prepare_data.R`:

```r
# 01_prepare_data.R
# Purpose: Prepare penguin data for analysis

library(palmerpenguins)
library(tidyverse)

penguins_clean <- penguins %>%
  drop_na() %>%
  mutate(log_body_mass = log(body_mass_g))

write_csv(penguins_clean, "analysis/data/derived_data/penguins_clean.csv")

cat("Prepared", nrow(penguins_clean), "observations\n")
```

### Script 2: Fit Models

Create `analysis/scripts/02_fit_models.R`:

```r
# 02_fit_models.R
# Purpose: Fit regression models

library(tidyverse)
library(broom)

penguins_clean <- read_csv("analysis/data/derived_data/penguins_clean.csv")

simple_model <- lm(body_mass_g ~ flipper_length_mm, data = penguins_clean)

write_csv(tidy(simple_model, conf.int = TRUE),
          "analysis/data/derived_data/model_coefficients.csv")
saveRDS(simple_model, "analysis/data/derived_data/simple_model.rds")

cat("R-squared:", round(summary(simple_model)$r.squared, 3), "\n")
```

### Script 3: Generate Figures

Create `analysis/scripts/03_generate_figures.R`:

```r
# 03_generate_figures.R
# Purpose: Generate publication-quality figures

library(tidyverse)

penguins_clean <- read_csv("analysis/data/derived_data/penguins_clean.csv")
simple_model <- readRDS("analysis/data/derived_data/simple_model.rds")

penguin_colors <- c("Adelie" = "#FF6B6B",
                    "Chinstrap" = "#9B59B6",
                    "Gentoo" = "#2E86AB")

# EDA overview
p1 <- ggplot(penguins_clean,
             aes(x = flipper_length_mm, y = body_mass_g, color = species)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  scale_color_manual(values = penguin_colors) +
  theme_minimal() +
  labs(title = "Flipper Length vs Body Mass")

ggsave("analysis/figures/eda-overview.png", p1,
       width = 8, height = 5, dpi = 300)

# Model diagnostics
png("analysis/figures/model-diagnostics.png",
    width = 10, height = 8, res = 300, units = "in")
par(mfrow = c(2, 2))
plot(simple_model)
dev.off()

cat("Figures saved to analysis/figures/\n")
```

## Step 6: Develop in Container

```bash
# Build Docker image
make docker-build

# Enter container
make r

# Install required packages
R
> install.packages(c("palmerpenguins", "tidyverse", "broom"))
> q()  # Auto-snapshot on exit captures packages

# Run analysis pipeline
Rscript analysis/scripts/01_prepare_data.R
Rscript analysis/scripts/02_fit_models.R
Rscript analysis/scripts/03_generate_figures.R

# Render blog post (from post root, via symlink)
quarto render index.qmd

# Exit container
exit
```

## Step 7: Add Makefile Targets

Add to `Makefile`:

```makefile
.PHONY: post-analysis post-render docker-post-render docker-post-preview

# Run analysis pipeline
post-analysis:
	Rscript analysis/scripts/01_prepare_data.R
	Rscript analysis/scripts/02_fit_models.R
	Rscript analysis/scripts/03_generate_figures.R

# Render blog post (via root symlink)
post-render: post-analysis
	quarto render index.qmd

# Docker versions
docker-post-render:
	docker run --rm -v "$$(pwd):/project" -w /project $(DOCKER_IMAGE) \
		make post-render

docker-post-preview:
	docker run --rm -p 8080:8080 -v "$$(pwd):/project" -w /project $(DOCKER_IMAGE) \
		quarto preview index.qmd --host 0.0.0.0 --port 8080
```

# Integration with Parent Blog

## Parent Blog _quarto.yml

Your existing Quarto blog configuration works unchanged:

```yaml
project:
  type: website
  render:
    - "*.qmd"
    - "posts/*/index.qmd"    # Finds symlinked index.qmd
    - "!posts/*/analysis/scripts/"
    - "!posts/*/R/"
```

## Rendering Workflow

### Option 1: Render Posts Individually

```bash
# Each post renders in its own container (full reproducibility)
cd posts/palmer_penguins_part1
make docker-post-render

cd ../palmer_penguins_part2
make docker-post-render

# Build parent blog
cd ../..
quarto render
```

### Option 2: Batch Render Script

Create `render_all_posts.sh` at blog root:

```bash
#!/bin/bash
set -e

for post in posts/*/; do
    if [ -f "$post/Makefile" ] && [ -f "$post/Dockerfile" ]; then
        echo "=== Rendering: $post ==="
        (cd "$post" && make docker-build && make docker-post-render)
    fi
done

echo "=== Building site ==="
quarto render
```

# Media Asset Guidelines

## Generated Figures (`analysis/figures/`)

- Created by R scripts in `analysis/scripts/`
- Fully reproducible from code
- PNG format, 300 DPI recommended
- Naming: `eda-overview.png`, `model-diagnostics.png`

## Static Images (`analysis/media/images/`)

- Hero images for blog listing
- Photos, screenshots, diagrams
- **Document sources** in `README.md`:

```markdown
# Image Sources

## penguin-hero.jpg
- Source: Unsplash
- Photographer: Derek Oyen
- License: Unsplash License
- URL: https://unsplash.com/photos/xxxxx
```

## Audio (`analysis/media/audio/`)

- Podcast episodes
- Audio summaries
- Formats: MP3, WAV, OGG

## Video (`analysis/media/video/`)

- Analysis walkthroughs
- Tutorial screencasts
- Formats: MP4, WebM

## Git LFS for Large Files

```bash
git lfs install
git lfs track "analysis/media/video/*.mp4"
git lfs track "analysis/media/audio/*.mp3"
git add .gitattributes
```

# Version Control

## .gitignore

```gitignore
# Rendered output (regenerated from source)
*.html
*_files/

# R artifacts
.Rhistory
.RData
.Rproj.user/

# OS files
.DS_Store

# Don't ignore symlinks - they're part of the structure
# !index.qmd  # This is a symlink, keep it
```

## Committing Symlinks

Git tracks symlinks as files containing the target path. Commit them:

```bash
git add index.qmd figures media data
git add analysis/report/figures analysis/report/media analysis/report/data
git commit -m "Add symlink structure for blog post"
```

## Complete Commit

```bash
git add .
git commit -m "Add Palmer Penguins Part 1: Reproducible blog post

Structure:
- analysis/report/index.qmd: Blog post content
- analysis/scripts/: Analysis pipeline (3 scripts)
- analysis/figures/: Generated plots
- analysis/media/: Static images, audio, video
- Dual symlinks for Quarto compatibility

Reproduce:
  make docker-build && make docker-post-render"
```

# Reader Instructions (README.md)

```markdown
# Palmer Penguins Part 1: EDA and Simple Regression

This blog post is a **reproducible research compendium**.

## Quick Start

```bash
git clone https://github.com/yourusername/qblog.git
cd qblog/posts/palmer_penguins_part1

make docker-build
make docker-post-render

open index.html
```

## Requirements

- Docker
- Make

## Structure

```
├── index.qmd              # Symlink to analysis/report/index.qmd
├── figures/               # Symlink to analysis/figures/
├── media/                 # Symlink to analysis/media/
├── analysis/
│   ├── paper/index.qmd    # Blog post (actual file)
│   ├── scripts/           # Analysis pipeline
│   ├── figures/           # Generated plots
│   ├── media/             # Static assets
│   └── data/              # Raw and derived data
├── Dockerfile             # Computational environment
└── renv.lock              # R package versions
```

## Reproducibility

All figures are generated by scripts in `analysis/scripts/`.
Run the pipeline: `make post-analysis`
```

# Best Practices Summary

## Structure

- **Blog post in `analysis/report/index.qmd`** - Consistent with rrtools
- **Dual symlinks** - Root level for Quarto, paper level for editing
- **Numbered scripts** - Clear execution order
- **Separate figures from media** - Generated vs static

## Paths in index.qmd

Write simple, intuitive paths:

```markdown
![Plot](figures/plot.png)           # Works via symlink
![Hero](media/images/hero.jpg)      # Works via symlink
```

## Reproducibility

- **Docker + renv.lock** - Frozen environment
- **Scripts generate, post presents** - Separation of concerns
- **README with instructions** - Clear reproduction steps
- **Git LFS for large media** - Video, audio files

## Workflow

```bash
make docker-build         # Build environment
make r            # Interactive development
make docker-post-render   # Full pipeline + render
```

# Self-Contained Project Guidelines

## Why Self-Containment Matters

Each blog post should be a truly **self-contained** reproducible project. This means:

1. **No external dependencies** on parent project paths
2. **All assets included** in the post directory
3. **Can be cloned independently** and rendered without the parent blog
4. **Images live in `analysis/media/`** not referenced from elsewhere

## Image Placement: The Critical Detail

**DO ✅**: Copy/store images inside the post's `analysis/media/images/` directory

```bash
# Copy hero image INTO the post
cp ~/assets/penguin-hero.jpg posts/my_post/analysis/media/images/

# Reference it locally in your index.qmd
![Hero image](media/images/penguin-hero.jpg){.img-fluid}
```

**DON'T ❌**: Reference images from parent project paths

```bash
# AVOID: This breaks if post is cloned independently
![Hero image](../../images/posts/penguin-hero.jpg){.img-fluid}
```

## Verifying Self-Containment

Test that your blog post is truly self-contained:

```bash
# Clone just the post directory (simulating independent use)
git clone --sparse https://github.com/yourrepo qblog
cd qblog
git sparse-checkout set posts/my_post
cd posts/my_post

# Try to render - should work without parent project
make docker-build
make docker-post-render

# If images render correctly, you're self-contained ✓
open index.html
```

## Media Directory Checklist

Before publishing your blog post, verify:

- ✓ All images are in `analysis/media/images/`
- ✓ `analysis/media/images/README.md` documents all image sources
- ✓ All image paths use `media/images/filename` (not `../../images/...`)
- ✓ Large media files (video, audio) use Git LFS tracking
- ✓ Post renders successfully: `make docker-post-render`
- ✓ Post is self-contained: can clone just this directory and render

## Example: Complete Self-Contained Post

```
posts/my_analysis/
├── index.qmd → analysis/report/index.qmd       # Symlink
├── figures/ → analysis/figures/                # Symlink
├── media/ → analysis/media/                    # Symlink
├── data/ → analysis/data/                      # Symlink
│
├── analysis/report/
│   ├── index.qmd                               # Actual blog post file
│   ├── figures/ → ../figures/                  # Symlink
│   ├── media/ → ../media/                      # Symlink
│   └── data/ → ../data/                        # Symlink
│
├── analysis/media/
│   └── images/
│       ├── README.md                           # Image sources/licenses
│       ├── hero-image.jpg                      # ✓ STORED HERE (12 MB)
│       └── supporting-photo.jpg                # ✓ STORED HERE
│
├── analysis/figures/                           # Generated by scripts
│   ├── eda-plot.png
│   └── model-diagnostics.png
│
├── Dockerfile                                  # Complete environment
├── renv.lock                                   # Exact packages
├── DESCRIPTION
├── Makefile
└── README.md
```

In `analysis/report/index.qmd`:

```markdown
---
title: "My Analysis"
image: "media/images/hero-image.jpg"  # YAML also uses local path
---

![Hero](media/images/hero-image.jpg){.img-fluid}  # Local reference
```

## Template Post as Reference

The `template_post/` in your ZZCOLLAB installation serves as a **working exemplar** of a self-contained blog post:

```bash
# Copy the template as your starting point
cp -r /path/to/zzcollab/template_post posts/my_new_post

# It already has:
# ✓ Correct directory structure
# ✓ Images in analysis/media/images/
# ✓ All symlinks properly set up
# ✓ Example YAML and content
# ✓ Analysis scripts showing best practices

# Just customize the content
cd posts/my_new_post
$EDITOR analysis/report/index.qmd
```

# References
