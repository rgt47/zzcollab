#!/bin/bash
set -euo pipefail
##############################################################################
# ZZCOLLAB STRUCTURE MODULE
##############################################################################
# 
# PURPOSE: Project structure creation and navigation setup
#          - Directory structure creation with tracking
#          - Symbolic link creation for convenience navigation
#          - Project layout management with uninstall support
#
# DEPENDENCIES: core.sh (for logging functions)
#
# TRACKING: All directories and symlinks created are tracked for uninstall
##############################################################################

# Validate core module is loaded
# Validate required modules are loaded
require_module "core"

#=============================================================================
# MANIFEST TRACKING FUNCTIONS
#=============================================================================

# Tracking functions are now provided by core.sh

#=============================================================================
# DIRECTORY STRUCTURE CREATION
#=============================================================================

# Function: create_directory_structure
# Purpose: Creates the complete directory structure for the R research compendium
# Creates: 16 directories organized for R package development and research workflow
#
# Directory Layout Created:
#   R/                      - R package functions (exported to users)
#   man/                    - Manual pages (generated by roxygen2)
#   tests/testthat/         - Unit tests using testthat framework
#   vignettes/              - Package vignettes and tutorials
#   data/                   - R package data (for package distribution)
#   analysis/               - Research analysis components (rrtools)
#   â”œâ”€â”€ data/               - Research data
#   â”‚   â”œâ”€â”€ raw_data/       - Original, unmodified datasets
#   â”‚   â””â”€â”€ derived_data/   - Processed, analysis-ready data
#   â”œâ”€â”€ paper/              - Research paper (Rmd â†’ PDF, rrtools standard)
#   â”œâ”€â”€ figures/            - Generated plots and visualizations
#   â”œâ”€â”€ tables/             - Generated statistical tables
#   â”œâ”€â”€ templates/          - Analysis templates and snippets
#   â””â”€â”€ scripts/            - Working R scripts and exploratory analysis
#   docs/                   - Project documentation
#   .github/workflows/      - GitHub Actions CI/CD pipelines
#
# Error Handling: Fails fast if any directory creation fails
# Tracking: All created directories are tracked in manifest for uninstall
create_directory_structure() {
    log_debug "Creating directory structure..."

    # Define all directories to create in logical order
    # Each directory serves a specific purpose in the research workflow
    # Following rrtools framework structure (Marwick et al. 2018)
    local -r dirs=(
        "R"                      # R package functions
        "man"                    # Manual pages
        "tests/testthat"         # Unit tests with testthat subdirectory
        "vignettes"              # Package vignettes
        "data"                   # R package data (for package distribution)
        "modules"                # Shell scripts for package validation and tooling
        "analysis"               # Analysis workflow root
        "analysis/data"          # Research data root
        "analysis/data/raw_data"          # Raw, unmodified data
        "analysis/data/derived_data"      # Processed data ready for analysis
        "analysis/paper"         # Research paper development (rrtools standard)
        "analysis/figures"       # Generated plots and figures
        "analysis/tables"        # Generated tables and summaries
        "analysis/templates"     # Analysis templates and reusable code
        "analysis/scripts"       # Working R scripts and exploratory analysis
        "docs"                   # Project documentation
        ".github/workflows"      # GitHub Actions CI/CD workflows
    )

    # Create each directory and track it for uninstall capability
    for dir in "${dirs[@]}"; do
        # mkdir -p creates parent directories as needed and doesn't fail if directory exists
        if mkdir -p "$dir"; then
            # Track successful directory creation for uninstall manifest
            track_directory "$dir"
            log_debug "Created directory: $dir"
        else
            log_error "Failed to create directory: $dir"
            return 1
        fi
    done

    log_success "Structure (${#dirs[@]} dirs, 40 files)"
}

#=============================================================================
# DATA DIRECTORY TEMPLATES
#=============================================================================

# Function: create_data_templates
# Purpose: Create documentation templates for data directory (rrtools structure)
create_data_templates() {
    log_debug "Creating data directory templates..."

    # Install data README template to document data structure and processing (rrtools location)
    if install_template "data_README.md" "analysis/data/README.md" "data directory documentation" "Created data directory README with Palmer Penguins example"; then
        log_debug "Data README template created"
    else
        log_error "Failed to create data README template"
        return 1
    fi

    # Install data workflow guide template to docs directory
    if install_template "DATA_WORKFLOW_GUIDE.md" "docs/DATA_WORKFLOW_GUIDE.md" "data workflow documentation" "Created comprehensive data development workflow guide"; then
        log_debug "Data workflow guide template created"
    else
        log_error "Failed to create data workflow guide template"
        return 1
    fi
}

#=============================================================================
# STRUCTURE VALIDATION AND REPORTING
#=============================================================================

# Function: validate_directory_structure
# Purpose: Verify that all required directories were created successfully
# Returns: 0 if all directories exist, 1 if any are missing
validate_directory_structure() {
    local -r required_dirs=(
        "R" "man" "tests/testthat" "vignettes" "data" "analysis"
        "analysis/data" "analysis/data/raw_data" "analysis/data/derived_data"
        "analysis/paper" "analysis/figures" "analysis/tables" "analysis/templates"
        "analysis/scripts" "docs" ".github/workflows"
    )

    validate_directories_exist "Directory structure" "${required_dirs[@]}"
}

# Function: show_structure_summary
# Purpose: Display a summary of the created project structure (only with -v)
show_structure_summary() {
    # Only show detailed structure with verbose mode
    if [[ $VERBOSITY_LEVEL -lt 2 ]]; then
        return 0
    fi

    log_info "Project structure summary:"
    cat << 'EOF' >&2
ğŸ“ PROJECT STRUCTURE CREATED (rrtools framework):

â”œâ”€â”€ R/                     # Package functions (exported to users)
â”œâ”€â”€ man/                   # Manual pages (generated by roxygen2)
â”œâ”€â”€ tests/testthat/        # Unit tests using testthat framework
â”œâ”€â”€ vignettes/             # Package vignettes and tutorials
â”œâ”€â”€ data/                  # R package data (for distribution)
â”œâ”€â”€ analysis/              # Research analysis workflow (rrtools)
â”‚   â”œâ”€â”€ data/              # Research data
â”‚   â”‚   â”œâ”€â”€ raw_data/      # Original, unmodified datasets
â”‚   â”‚   â””â”€â”€ derived_data/  # Processed, analysis-ready data
â”‚   â”œâ”€â”€ paper/             # Research paper (Rmd â†’ PDF)
â”‚   â”œâ”€â”€ figures/           # Generated plots and visualizations
â”‚   â”œâ”€â”€ tables/            # Generated statistical tables
â”‚   â”œâ”€â”€ templates/         # Analysis templates
â”‚   â””â”€â”€ scripts/           # Working R scripts and exploration
â”œâ”€â”€ docs/                  # Project documentation
â””â”€â”€ .github/workflows/     # GitHub Actions CI/CD pipelines

ğŸ”— QUICK NAVIGATION:
   cd a  â†’  analysis/data/      cd n  â†’  analysis/
   cd f  â†’  analysis/figures/   cd t  â†’  analysis/tables/
   cd s  â†’  analysis/scripts/   cd p  â†’  analysis/paper/
   cd m  â†’  man/                cd e  â†’  tests/
   cd o  â†’  docs/
EOF
}

#=============================================================================
# STRUCTURE MODULE VALIDATION
#=============================================================================

# Validate that required manifest variables are available
if [[ -z "${MANIFEST_FILE:-}" ]]; then
    log_warn "MANIFEST_FILE not defined - tracking will be disabled"
fi

if [[ -z "${MANIFEST_TXT:-}" ]]; then
    log_warn "MANIFEST_TXT not defined - fallback tracking will be disabled"
fi


