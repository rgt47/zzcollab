# syntax=docker/dockerfile:1.4
#======================================================================
# ZZCOLLAB Ubuntu Standard Publishing Profile
#======================================================================
# Profile: ubuntu_standard_publishing (~2.5GB)
# Purpose: Academic papers, books, blogs with LaTeX, Quarto, RStudio
# Base: rocker/verse (R + tidyverse + LaTeX + RStudio Server)
# Packages: tidyverse, quarto, bookdown, blogdown, distill, rmarkdown,
#           knitr, flexdashboard, xaringan, renv, devtools
#           (binaries from r2u)
#
# Build: DOCKER_BUILDKIT=1 docker build \
#          -f Dockerfile.ubuntu_standard_publishing \
#          -t myteam/project:ubuntu-standard-publishing .
# Note: AMD64 only - ARM64 not natively supported by rocker/verse
#======================================================================

ARG R_VERSION=latest
ARG USERNAME=analyst
ARG TEAM_NAME=zzcollab
ARG PROJECT_NAME=project
ARG TARGETPLATFORM

# Force AMD64 platform for rocker/verse (ARM64 not natively supported)
FROM --platform=linux/amd64 rocker/verse:${R_VERSION}

ARG USERNAME=analyst
ARG TEAM_NAME=zzcollab
ARG PROJECT_NAME=project
ARG DEBIAN_FRONTEND=noninteractive
ARG TARGETPLATFORM

# Platform note (verse is AMD64 only, using emulation on ARM64)
RUN if [ "${TARGETPLATFORM}" = "linux/arm64" ]; then \
        echo "NOTE: rocker/verse does not support ARM64 natively" >&2; \
        echo "Running AMD64 image via emulation (slower)" >&2; \
    fi

# Install runtime dependencies and r2u repository in single layer
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    set -ex && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        wget \
        ca-certificates && \
    # r2u repository for binary R packages
    wget -q -O- \
        https://eddelbuettel.github.io/r2u/assets/\
dirk_eddelbuettel_key.asc | \
        tee -a /etc/apt/trusted.gpg.d/cranapt_key.asc && \
    echo "deb [arch=amd64,arm64] \
https://r2u.stat.illinois.edu/ubuntu noble main" > \
        /etc/apt/sources.list.d/cranapt.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        # Shell
        zsh \
        # Publishing runtime (pandoc, LaTeX already in rocker/verse)
        # Minimal runtime libraries for R packages
        libfontconfig1 \
        libfreetype6 \
        libpng16-16 \
        libjpeg8 \
        # RStudio Server needs curl for health checks
        curl

# Configure repositories: RSPM with binary packages
# Use a known good date (2024-10-26) to ensure packages are available
RUN UBUNTU_CODENAME=$(. /etc/os-release && \
        echo $VERSION_CODENAME) && \
    echo "options(repos = c(" \
        "CRAN = 'https://packagemanager.posit.co/cran/\
__linux__/${UBUNTU_CODENAME}/2024-10-26'))" \
        >> /usr/local/lib/R/etc/Rprofile.site && \
    echo "options(HTTPUserAgent = sprintf('R/%s R (%s)', \
getRversion(), paste(getRversion(), R.version\$platform, \
R.version\$arch, R.version\$os)))" \
        >> /usr/local/lib/R/etc/Rprofile.site

# Install publishing packages from r2u (binary packages)
RUN --mount=type=cache,target=/tmp/R-cache/${R_VERSION} \
    R -e "install.packages(c('renv', 'devtools', 'quarto', \
        'bookdown', 'blogdown', 'distill', 'rmarkdown', 'knitr', \
        'flexdashboard', 'xaringan'))"

# Create user and set up environment
RUN useradd --create-home --shell /bin/zsh ${USERNAME} && \
    mkdir -p /home/${USERNAME}/project && \
    chown -R ${USERNAME}:${USERNAME} /home/${USERNAME} && \
    chown -R ${USERNAME}:${USERNAME} /usr/local/lib/R/site-library

# Switch to user
USER ${USERNAME}
WORKDIR /home/${USERNAME}/project

# Copy project files
COPY --chown=${USERNAME}:${USERNAME} renv.lock .Rprofile DESCRIPTION ./
COPY --chown=${USERNAME}:${USERNAME} renv ./renv

# Restore renv packages
RUN R -e "renv::restore()"

# Copy remaining project files (last - most frequent changes)
COPY --chown=${USERNAME}:${USERNAME} . .

# Install research compendium
RUN R -e "install.packages('.', repos = NULL, type = 'source', \
    dependencies = TRUE)"

# Metadata
LABEL org.opencontainers.image.title=\
"ZZCOLLAB Ubuntu Standard Publishing Environment" \
      org.opencontainers.image.description=\
"Academic papers, books, blogs with LaTeX, Quarto, RStudio" \
      org.opencontainers.image.vendor="ZZCOLLAB" \
      org.opencontainers.image.authors="${TEAM_NAME}" \
      org.opencontainers.image.source=\
"https://github.com/${TEAM_NAME}/${PROJECT_NAME}" \
      zzcollab.profile="ubuntu_standard_publishing" \
      zzcollab.size="~2.5GB"

# Health check for RStudio Server
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8787/ || exit 1

# Copy and configure ZZCOLLAB entrypoint for auto-snapshot on exit
# (requires root)
USER root
COPY zzcollab-entrypoint.sh /usr/local/bin/zzcollab-entrypoint.sh
RUN chmod +x /usr/local/bin/zzcollab-entrypoint.sh

# Stay as root - RStudio's /init handles user switching
ENTRYPOINT ["/usr/local/bin/zzcollab-entrypoint.sh"]
CMD ["/init"]
