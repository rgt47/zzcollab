# syntax=docker/dockerfile:1.4
#======================================================================
# ZZCOLLAB Ubuntu Standard Minimal Profile
#======================================================================
# Profile: ubuntu_standard_minimal (~1.0GB)
# Purpose: Minimal R runtime (no X11, no GUI)
# Base: rocker/r-ver (R + minimal dependencies)
# Packages: renv (binary from r2u)
#
# Build: DOCKER_BUILDKIT=1 docker build \
#          -f Dockerfile.ubuntu_standard_minimal \
#          -t myteam/project:standard-minimal .
#======================================================================

ARG R_VERSION=4.4.2
ARG RENV_VERSION=1.1.5
ARG USERNAME=analyst
ARG TEAM_NAME=zzcollab
ARG PROJECT_NAME=project

FROM rocker/r-ver:${R_VERSION}

ARG RENV_VERSION=1.1.5
ARG USERNAME=analyst
ARG TEAM_NAME=zzcollab
ARG PROJECT_NAME=project
ARG DEBIAN_FRONTEND=noninteractive

# Reproducibility-critical environment variables (Pillar 1)
ENV LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    TZ=UTC \
    OMP_NUM_THREADS=1 \
    RENV_PATHS_CACHE=/home/analyst/.cache/R/renv

# Install runtime dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    set -ex && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        libfontconfig1 \
        libfreetype6 \
        libpng16-16 \
        libjpeg8

# Configure R to use CRAN
RUN echo "options(repos = c(CRAN = 'https://cloud.r-project.org'))" \
        >> /usr/local/lib/R/etc/Rprofile.site

# Create user and set up environment
# Note: renv will self-bootstrap on first use via renv/activate.R
RUN useradd --create-home --shell /bin/bash ${USERNAME} && \
    mkdir -p /home/${USERNAME}/project && \
    chown -R ${USERNAME}:${USERNAME} /home/${USERNAME} && \
    chown -R ${USERNAME}:${USERNAME} /usr/local/lib/R/site-library

# Switch to user
USER ${USERNAME}
WORKDIR /home/${USERNAME}/project

# Note: Project files are mounted at runtime via -v $(pwd):/home/analyst/project
# renv will self-bootstrap on first R session via renv/activate.R (sourced by .Rprofile)
# This eliminates Docker build dependency and keeps images lightweight

CMD ["R", "--quiet"]
