name: Analysis Pipeline

# ðŸŽ¯ What this workflow does:
# - Runs your complete analysis pipeline from data preparation to final outputs
# - Auto-detects numbered scripts (01_*, 02_*, etc.) in analysis/scripts/
# - Validates outputs at each step
# - Uploads analysis artifacts (data, figures, reports)
#
# ðŸ”§ Customize:
# - Adjust script paths if your structure differs
# - Add specific validation checks for your project
# - Modify artifact retention period (default: 90 days)

on:
  push:
    branches: [main, master]
    paths:
      - 'analysis/scripts/**'
      - 'R/**'
      - 'analysis/data/**'
      - 'renv.lock'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Prevent runaway processes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Cache renv packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/R/renv
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev

      - name: Restore R packages
        run: |
          Rscript -e "renv::restore()"

      - name: Validate project structure
        run: |
          echo "::group::Project structure"
          if [ -d "analysis/scripts" ]; then
            echo "âœ… analysis/scripts/ directory found"
          fi
          if [ -d "analysis/data" ]; then
            echo "âœ… analysis/data/ directory found"
          fi
          if [ -d "R" ]; then
            echo "âœ… R/ directory found"
          fi
          echo "::endgroup::"

      - name: Auto-detect and run analysis scripts
        run: |
          cd analysis/scripts
          SCRIPTS=$(ls -1 [0-9][0-9]_*.R 2>/dev/null | sort)

          if [ -z "$SCRIPTS" ]; then
            echo "âŒ No numbered scripts found (pattern: NN_*.R)"
            exit 1
          fi

          echo "ðŸ“‹ Found scripts:"
          echo "$SCRIPTS"
          echo ""

          for script in $SCRIPTS; do
            echo "::group::Running $script"
            echo "âš™ï¸  Executing: $script"
            Rscript "$script"
            EXIT_CODE=$?

            if [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ Script failed with exit code $EXIT_CODE"
              echo "::endgroup::"
              exit $EXIT_CODE
            fi
            echo "âœ… Completed successfully"
            echo "::endgroup::"
          done

      - name: Verify analysis outputs
        run: |
          echo "::group::Checking output files"

          # Check for derived data
          if [ -d "analysis/data/derived_data" ]; then
            echo "ðŸ“Š Derived data files:"
            find analysis/data/derived_data -name "*.RData" -o -name "*.rds" | while read file; do
              SIZE=$(ls -lh "$file" | awk '{print $5}')
              echo "  âœ… $(basename $file) ($SIZE)"
            done
          fi

          # Check for figures
          if [ -d "analysis/figures" ]; then
            FIG_COUNT=$(find analysis/figures -name "*.pdf" -o -name "*.png" | wc -l)
            echo "ðŸ“ˆ Generated $FIG_COUNT figures"
          fi

          # Check for reports
          if [ -d "analysis/report" ]; then
            REPORT_COUNT=$(find analysis/report -name "*.pdf" -o -name "*.html" | wc -l)
            echo "ðŸ“„ Generated $REPORT_COUNT reports"
          fi

          echo "::endgroup::"

      - name: Run targets pipeline (if present)
        continue-on-error: true
        run: |
          if [ -f "_targets.R" ]; then
            echo "ðŸŽ¯ Running targets pipeline"
            Rscript -e "targets::tar_make()"
          else
            echo "No targets pipeline found (skipping)"
          fi

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-outputs
          path: |
            analysis/data/derived_data/*.RData
            analysis/data/derived_data/*.rds
            analysis/figures/*.pdf
            analysis/figures/*.png
            analysis/report/*.pdf
            analysis/report/*.html
          retention-days: 90
          if-no-files-found: warn

      - name: Generate analysis summary
        if: success()
        run: |
          echo "## âœ… Analysis Pipeline Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Scripts Executed" >> $GITHUB_STEP_SUMMARY
          cd analysis/scripts
          ls -1 [0-9][0-9]_*.R 2>/dev/null | while read script; do
            echo "- âœ… \`$script\`" >> $GITHUB_STEP_SUMMARY
          done
          cd ../..

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs Generated" >> $GITHUB_STEP_SUMMARY

          if [ -d "analysis/data/derived_data" ]; then
            DATA_COUNT=$(find analysis/data/derived_data -name "*.RData" -o -name "*.rds" | wc -l)
            echo "- **Derived data files**: $DATA_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "analysis/figures" ]; then
            FIG_COUNT=$(find analysis/figures -name "*.pdf" -o -name "*.png" | wc -l)
            echo "- **Figures**: $FIG_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "analysis/report" ]; then
            REPORT_COUNT=$(find analysis/report -name "*.pdf" -o -name "*.html" | wc -l)
            echo "- **Reports**: $REPORT_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Download artifacts**: Check 'Artifacts' section above" >> $GITHUB_STEP_SUMMARY
