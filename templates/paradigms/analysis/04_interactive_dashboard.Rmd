---
title: "{{PACKAGE_NAME}} Analysis Dashboard"
author: "{{AUTHOR_NAME}} {{AUTHOR_LAST}}"
date: "`r Sys.Date()`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: bootstrap
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
# Dashboard setup with reproducibility focus
library(flexdashboard)
library(shiny)
library(DT)
library(plotly)
library(dplyr)
library(ggplot2)
library(here)
library(readr)

# Set reproducible options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Load data and models (customize for your project)
# data_processed <- read_csv(here("data", "processed", "cleaned_dataset.csv"))
# final_model <- readRDS(here("analysis", "modeling", "final_model.rds"))

# Create sample data for demonstration (remove when using real data)
set.seed(123)
data_processed <- data.frame(
  x1 = rnorm(500),
  x2 = rnorm(500),
  x3 = sample(c("A", "B", "C"), 500, replace = TRUE),
  outcome = rnorm(500) * 2 + 10
)

# Dashboard session tracking
session_info <- list(
  dashboard_name = "{{PACKAGE_NAME}} Analysis Dashboard",
  creation_time = Sys.time(),
  r_version = R.version.string,
  data_rows = nrow(data_processed),
  last_updated = file.mtime(here("data", "processed"))
)
```

Sidebar {.sidebar}
=====================================

### Dashboard Controls

```{r}
# Reproducible data filtering controls
selectInput("variable", "Select Variable:",
            choices = names(select_if(data_processed, is.numeric)),
            selected = names(select_if(data_processed, is.numeric))[1])

selectInput("grouping", "Group By:",
            choices = c("None", names(select_if(data_processed, function(x) is.factor(x) | is.character(x)))),
            selected = "None")

sliderInput("sample_size", "Sample Size:",
            min = 50, max = nrow(data_processed),
            value = min(500, nrow(data_processed)),
            step = 50)

# Reactive data subset
filtered_data <- reactive({
  req(input$sample_size)
  set.seed(123)  # Reproducible sampling
  data_processed %>%
    slice_sample(n = input$sample_size)
})
```

### Data Summary

```{r}
renderValueBox({
  valueBox(
    value = nrow(filtered_data()),
    caption = "Observations",
    icon = "fa-table",
    color = "primary"
  )
})
```

```{r}
renderValueBox({
  valueBox(
    value = ncol(data_processed),
    caption = "Variables",
    icon = "fa-columns",
    color = "info"
  )
})
```

```{r}
renderValueBox({
  valueBox(
    value = format(session_info$creation_time, "%H:%M:%S"),
    caption = "Generated At",
    icon = "fa-clock",
    color = "success"
  )
})
```

### Reproducibility Info

**R Version:** `r R.version.string`

**Last Data Update:** `r if(file.exists(here("data", "processed"))) format(max(file.mtime(list.files(here("data", "processed"), full.names = TRUE))), "%Y-%m-%d %H:%M")  else "N/A"`

**Random Seed:** 123 (for reproducible sampling)

Data Overview
=====================================

Column {data-width=650}
-----------------------------------------------------------------------

### Distribution Plot

```{r}
renderPlotly({
  req(input$variable)

  p <- filtered_data() %>%
    ggplot(aes_string(x = input$variable)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7, color = "white") +
    labs(
      title = paste("Distribution of", input$variable),
      subtitle = paste("Sample size:", nrow(filtered_data())),
      x = input$variable,
      y = "Frequency"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12)
    )

  # Add grouping if selected
  if (input$grouping != "None") {
    p <- p +
      facet_wrap(as.formula(paste("~", input$grouping))) +
      labs(subtitle = paste("Sample size:", nrow(filtered_data()), "| Grouped by:", input$grouping))
  }

  ggplotly(p, tooltip = c("count")) %>%
    config(displayModeBar = TRUE, displaylogo = FALSE) %>%
    layout(
      annotations = list(
        text = paste("Generated:", format(Sys.time(), "%Y-%m-%d %H:%M:%S")),
        x = 1, y = 1, xref = 'paper', yref = 'paper',
        xanchor = 'right', yanchor = 'top',
        showarrow = FALSE,
        font = list(size = 10, color = "grey")
      )
    )
})
```

Column {data-width=350}
-----------------------------------------------------------------------

### Summary Statistics

```{r}
renderDT({
  req(input$variable)

  summary_stats <- filtered_data() %>%
    select(all_of(input$variable)) %>%
    summarise(
      Variable = input$variable,
      Count = n(),
      Missing = sum(is.na(.data[[input$variable]])),
      Mean = round(mean(.data[[input$variable]], na.rm = TRUE), 3),
      Median = round(median(.data[[input$variable]], na.rm = TRUE), 3),
      SD = round(sd(.data[[input$variable]], na.rm = TRUE), 3),
      Min = round(min(.data[[input$variable]], na.rm = TRUE), 3),
      Max = round(max(.data[[input$variable]], na.rm = TRUE), 3)
    )

  if (input$grouping != "None") {
    summary_stats <- filtered_data() %>%
      group_by(.data[[input$grouping]]) %>%
      summarise(
        Count = n(),
        Missing = sum(is.na(.data[[input$variable]])),
        Mean = round(mean(.data[[input$variable]], na.rm = TRUE), 3),
        Median = round(median(.data[[input$variable]], na.rm = TRUE), 3),
        SD = round(sd(.data[[input$variable]], na.rm = TRUE), 3),
        Min = round(min(.data[[input$variable]], na.rm = TRUE), 3),
        Max = round(max(.data[[input$variable]], na.rm = TRUE), 3),
        .groups = "drop"
      ) %>%
      rename(Group = 1)
  }

  datatable(
    summary_stats,
    options = list(
      dom = 't',
      scrollX = TRUE,
      pageLength = 10
    ),
    rownames = FALSE,
    caption = htmltools::tags$caption(
      style = "font-size: 12px; color: grey;",
      paste("Summary generated:", format(Sys.time(), "%H:%M:%S"))
    )
  ) %>%
    formatRound(columns = c("Mean", "Median", "SD", "Min", "Max"), digits = 3)
})
```

### Data Quality Check

```{r}
renderDT({
  quality_summary <- filtered_data() %>%
    summarise_all(list(
      Missing = ~sum(is.na(.)),
      Missing_Pct = ~round(sum(is.na(.)) / length(.) * 100, 1)
    )) %>%
    tidyr::pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
    tidyr::separate(metric, into = c("Variable", "Metric"), sep = "_(?=Missing)") %>%
    tidyr::pivot_wider(names_from = "Metric", values_from = "value") %>%
    arrange(desc(Missing))

  datatable(
    quality_summary,
    options = list(
      dom = 't',
      scrollY = "300px",
      scrollX = TRUE,
      pageLength = -1
    ),
    rownames = FALSE,
    caption = "Data Quality Assessment"
  ) %>%
    formatStyle(
      "Missing_Pct",
      backgroundColor = styleInterval(c(5, 20), c("white", "yellow", "red")),
      color = styleInterval(c(20), c("black", "white"))
    )
})
```

Exploratory Analysis
=====================================

Column {data-width=600}
-----------------------------------------------------------------------

### Correlation Matrix

```{r}
renderPlotly({
  numeric_data <- filtered_data() %>%
    select_if(is.numeric)

  if (ncol(numeric_data) > 1) {
    cor_matrix <- cor(numeric_data, use = "complete.obs")

    # Convert to long format for ggplot
    cor_data <- cor_matrix %>%
      as.data.frame() %>%
      tibble::rownames_to_column("var1") %>%
      tidyr::pivot_longer(-var1, names_to = "var2", values_to = "correlation")

    p <- ggplot(cor_data, aes(x = var1, y = var2, fill = correlation, text = paste("Correlation:", round(correlation, 3)))) +
      geom_tile() +
      scale_fill_gradient2(
        low = "red", mid = "white", high = "blue",
        midpoint = 0, limit = c(-1, 1)
      ) +
      labs(
        title = "Correlation Matrix",
        subtitle = paste("Based on", nrow(numeric_data), "complete observations"),
        x = "Variables", y = "Variables"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    ggplotly(p, tooltip = "text") %>%
      config(displayModeBar = TRUE, displaylogo = FALSE)
  } else {
    plotly_empty() %>%
      add_text(x = 0.5, y = 0.5, text = "Need at least 2 numeric variables for correlation")
  }
})
```

Column {data-width=400}
-----------------------------------------------------------------------

### Variable Relationships

```{r}
# Select two numeric variables for scatter plot
numeric_vars <- names(select_if(data_processed, is.numeric))

selectInput("x_var", "X Variable:",
            choices = numeric_vars,
            selected = numeric_vars[1])

selectInput("y_var", "Y Variable:",
            choices = numeric_vars,
            selected = if(length(numeric_vars) > 1) numeric_vars[2] else numeric_vars[1])

checkboxInput("add_smooth", "Add Trend Line", value = TRUE)
```

```{r}
renderPlotly({
  req(input$x_var, input$y_var)

  p <- filtered_data() %>%
    ggplot(aes_string(x = input$x_var, y = input$y_var)) +
    geom_point(alpha = 0.6, color = "steelblue") +
    labs(
      title = paste(input$y_var, "vs", input$x_var),
      subtitle = paste("n =", nrow(filtered_data())),
      x = input$x_var,
      y = input$y_var
    ) +
    theme_minimal()

  if (input$add_smooth) {
    p <- p + geom_smooth(method = "lm", se = TRUE, color = "red")
  }

  # Add grouping color if selected
  if (input$grouping != "None") {
    p <- p +
      aes_string(color = input$grouping) +
      labs(subtitle = paste("n =", nrow(filtered_data()), "| Colored by:", input$grouping))
  }

  ggplotly(p) %>%
    config(displayModeBar = TRUE, displaylogo = FALSE) %>%
    layout(
      annotations = list(
        text = paste("Updated:", format(Sys.time(), "%H:%M:%S")),
        x = 1, y = 1, xref = 'paper', yref = 'paper',
        xanchor = 'right', yanchor = 'top',
        showarrow = FALSE,
        font = list(size = 10, color = "grey")
      )
    )
})
```

### Export Data

```{r}
downloadHandler(
  filename = function() {
    paste("dashboard_data_", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write_csv(filtered_data(), file)
  }
)

downloadButton("download_data", "Download Current Data", class = "btn-primary")
```

**Reproducibility Notes:**
- Random seed: 123
- Sampling is reproducible
- Data filtering applied consistently
- All plots generated with timestamps

Model Results
=====================================

Column {data-width=500}
-----------------------------------------------------------------------

### Model Performance

```{r}
# Load model results if available
model_results_file <- here("outputs", "tables", "model_comparison.csv")

renderPlotly({
  if (file.exists(model_results_file)) {
    model_results <- read_csv(model_results_file, show_col_types = FALSE)

    p <- model_results %>%
      ggplot(aes(x = reorder(model, -rmse), y = rmse)) +
      geom_col(fill = "steelblue", alpha = 0.7) +
      geom_text(aes(label = round(rmse, 3)), vjust = -0.5) +
      labs(
        title = "Model Performance Comparison",
        subtitle = "Root Mean Square Error (Lower is Better)",
        x = "Model",
        y = "RMSE"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    ggplotly(p) %>%
      config(displayModeBar = TRUE, displaylogo = FALSE)
  } else {
    plotly_empty() %>%
      add_text(x = 0.5, y = 0.5, text = "Model results not available. Run modeling pipeline first.")
  }
})
```

Column {data-width=500}
-----------------------------------------------------------------------

### Feature Importance

```{r}
renderPlotly({
  importance_file <- here("outputs", "tables", "feature_importance.csv")

  if (file.exists(importance_file)) {
    importance_data <- read_csv(importance_file, show_col_types = FALSE) %>%
      slice_head(n = 10)  # Top 10 features

    p <- importance_data %>%
      ggplot(aes(x = reorder(variable, importance), y = importance)) +
      geom_col(fill = "darkgreen", alpha = 0.7) +
      coord_flip() +
      labs(
        title = "Top 10 Feature Importance",
        subtitle = "Variable importance scores from final model",
        x = "Variables",
        y = "Importance Score"
      ) +
      theme_minimal()

    ggplotly(p) %>%
      config(displayModeBar = TRUE, displaylogo = FALSE)
  } else {
    plotly_empty() %>%
      add_text(x = 0.5, y = 0.5, text = "Feature importance not available. Run modeling pipeline first.")
  }
})
```

### Session Information

```{r}
renderText({
  paste(
    "Dashboard Session Information:",
    paste("Generated:", format(session_info$creation_time, "%Y-%m-%d %H:%M:%S")),
    paste("R Version:", session_info$r_version),
    paste("Data Observations:", session_info$data_rows),
    paste("Working Directory:", getwd()),
    sep = "\n"
  )
})
```